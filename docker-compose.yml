services:
  # Mock API Service (Node.js) - serves JSON data for Salesforce, Gainsight, Gong
  mock-api:
    build:
      context: ./mock-api-service
      dockerfile: Dockerfile
    container_name: csmpilot-mock-api
    ports:
      - "3002:3001" # External port 3002, internal 3001
    volumes:
      - ./mock-api-service:/app
      - /app/node_modules
    environment:
      - PORT=3001
      - NODE_ENV=development
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3001/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis service for Celery
  redis:
    image: redis:7-alpine
    container_name: csmpilot-redis
    ports:
      - "6380:6379" # Use port 6380 externally to avoid conflicts
    volumes:
      - redis_data:/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # PostgreSQL database (optional upgrade from SQLite)
  db:
    image: postgres:15-alpine
    container_name: csmpilot-db
    environment:
      POSTGRES_DB: csmpilot
      POSTGRES_USER: csmpilot_user
      POSTGRES_PASSWORD: csmpilot_password
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U csmpilot_user -d csmpilot"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Django backend
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: csmpilot-backend
    ports:
      - "8000:8000"
    environment:
      - DEBUG=True
      - SECRET_KEY=your-secret-key-here-change-in-production
      # Use PostgreSQL (comment out for SQLite)
      - DATABASE_URL=postgresql://csmpilot_user:csmpilot_password@db:5432/csmpilot
      # Or use SQLite (uncomment for SQLite)
      # - DATABASE_URL=sqlite:///db.sqlite3
      - REDIS_URL=redis://redis:6379/0
      - PINECONE_API_KEY=${PINECONE_API_KEY}
      - PINECONE_ENVIRONMENT=${PINECONE_ENVIRONMENT:-us-east-1-aws}
      - PINECONE_INDEX_NAME=${PINECONE_INDEX_NAME:-csm-pilot}
      - PINECONE_INDEX_HOST=${PINECONE_INDEX_HOST}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      # Mock API URLs (use Docker service name)
      - SALESFORCE_MOCK_API_URL=http://mock-api:3001/mock-apis/salesforce
      - GAINSIGHT_MOCK_API_URL=http://mock-api:3001/mock-apis/gainsight
      - GONG_MOCK_API_URL=http://mock-api:3001/mock-apis/gong
      # SSL certificates are properly handled in Linux container
      - PYTHONHTTPSVERIFY=1
    volumes:
      - ./backend:/app
      - backend_media:/app/media
      - backend_static:/app/static
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
      mock-api:
        condition: service_healthy
    restart: unless-stopped
    command: >
      sh -c "
        echo 'Setting up Django application...' &&
        python manage.py migrate &&
        python manage.py collectstatic --noinput &&
        echo 'Setting up Celery periodic tasks...' &&
        python manage.py shell < setup_celery_tasks.py || echo 'Periodic tasks setup completed' &&
        echo 'Starting Django server...' &&
        python manage.py runserver 0.0.0.0:8000
      "

  # Celery worker for async tasks
  celery:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: csmpilot-celery
    environment:
      - DEBUG=True
      - SECRET_KEY=your-secret-key-here-change-in-production
      # Use PostgreSQL (comment out for SQLite)
      - DATABASE_URL=postgresql://csmpilot_user:csmpilot_password@db:5432/csmpilot
      # Or use SQLite (uncomment for SQLite)
      # - DATABASE_URL=sqlite:///db.sqlite3
      - REDIS_URL=redis://redis:6379/0
      - PINECONE_API_KEY=${PINECONE_API_KEY}
      - PINECONE_ENVIRONMENT=${PINECONE_ENVIRONMENT:-us-east-1-aws}
      - PINECONE_INDEX_NAME=${PINECONE_INDEX_NAME:-csm-pilot}
      - PINECONE_INDEX_HOST=${PINECONE_INDEX_HOST}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      # Mock API URLs (use Docker service name)
      - SALESFORCE_MOCK_API_URL=http://mock-api:3001/mock-apis/salesforce
      - GAINSIGHT_MOCK_API_URL=http://mock-api:3001/mock-apis/gainsight
      - GONG_MOCK_API_URL=http://mock-api:3001/mock-apis/gong
      # SSL certificates work properly in Linux container
      - PYTHONHTTPSVERIFY=1
    volumes:
      - ./backend:/app
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
      backend:
        condition: service_started
      mock-api:
        condition: service_healthy
    restart: unless-stopped
    command: celery -A csmpilot worker --loglevel=info --pool=threads --concurrency=4

  # Celery beat for scheduled tasks (optional)
  celery-beat:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: csmpilot-celery-beat
    environment:
      - DEBUG=True
      - SECRET_KEY=your-secret-key-here-change-in-production
      # Use PostgreSQL (comment out for SQLite)
      - DATABASE_URL=postgresql://csmpilot_user:csmpilot_password@db:5432/csmpilot
      # Or use SQLite (uncomment for SQLite)
      # - DATABASE_URL=sqlite:///db.sqlite3
      - REDIS_URL=redis://redis:6379/0
      - PINECONE_API_KEY=${PINECONE_API_KEY}
      - PINECONE_ENVIRONMENT=${PINECONE_ENVIRONMENT:-us-east-1-aws}
      - PINECONE_INDEX_NAME=${PINECONE_INDEX_NAME:-csm-pilot}
      - PINECONE_INDEX_HOST=${PINECONE_INDEX_HOST}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      # Mock API URLs (use Docker service name)
      - SALESFORCE_MOCK_API_URL=http://mock-api:3001/mock-apis/salesforce
      - GAINSIGHT_MOCK_API_URL=http://mock-api:3001/mock-apis/gainsight
      - GONG_MOCK_API_URL=http://mock-api:3001/mock-apis/gong
    volumes:
      - ./backend:/app
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
      backend:
        condition: service_started
      mock-api:
        condition: service_healthy
    restart: unless-stopped
    command: celery -A csmpilot beat --loglevel=info

  # Next.js frontend
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: csmpilot-frontend
    ports:
      - "3001:3000" # Use port 3001 externally to avoid conflicts
    environment:
      - NODE_ENV=development
      - NEXT_PUBLIC_API_URL=http://localhost:8000
      - NEXT_PUBLIC_APP_NAME=CSM Copilot
      - NEXT_PUBLIC_OPENAI_API_KEY=${OPENAI_API_KEY}
    volumes:
      - ./frontend:/app
      - /app/node_modules
      - /app/.next
    depends_on:
      - backend
    restart: unless-stopped

  # Nginx reverse proxy (optional, for production)
  nginx:
    image: nginx:alpine
    container_name: csmpilot-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./docker/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./docker/nginx/ssl:/etc/nginx/ssl:ro
      - backend_static:/var/www/static:ro
      - backend_media:/var/www/media:ro
    depends_on:
      - backend
      - frontend
    restart: unless-stopped
    profiles:
      - production

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  backend_media:
    driver: local
  backend_static:
    driver: local

networks:
  default:
    name: csmpilot-network
